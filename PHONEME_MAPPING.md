# 音素マッピングについて

## 現在の実装

現在のPiper日本語実装では、OpenJTalkが生成する複数文字の音素（例：「ch」「ts」「sh」）を単一文字に分割しています。

### 例
- 「ち」: "ch" → "c" + "h"
- 「つ」: "ts" → "t" + "s"  
- 「し」: "sh" → "s" + "h"

## モデルの互換性

### 既存モデルの使用

**再学習なしで使用可能です**。ただし以下の点にご注意ください：

1. **警告メッセージ**
   ```
   [warning] Missing "c" (\u0063): 1 time(s)
   ```
   このような警告が表示されますが、音声は正常に生成されます。

2. **音質**
   - 基本的な音声合成は問題なく動作します
   - ただし、複数文字音素の分割により、若干の音質低下の可能性があります

### より高品質な音声を求める場合

以下の2つの選択肢があります：

#### 選択肢1: モデルの再学習（推奨）

Python側の前処理を修正して、複数文字音素を適切に扱うようにします：

```python
# preprocess.py の修正例
def process_phonemes(phonemes):
    # OpenJTalkの複数文字音素を保持
    # "ch", "ts", "sh" などをそのまま使用
    return phonemes  # 分割しない
```

#### 選択肢2: 音素マッピングテーブルの使用

C++側で音素マッピングテーブルを実装：

```cpp
// 音素マッピングの例
std::map<std::string, std::string> phoneme_map = {
    {"ch", "t"},  // "ch" を "t" にマッピング
    {"ts", "t"},  // "ts" を "t" にマッピング
    {"sh", "s"},  // "sh" を "s" にマッピング
};
```

## 推奨事項

### 新規プロジェクトの場合
- Python側とC++側で同じ音素体系を使用
- OpenJTalkの音素をそのまま使用することを推奨

### 既存モデルを使用する場合
- 現在の実装（音素分割）で問題なく動作
- 警告は無視して構いません

### 高品質な商用利用の場合
- モデルの再学習を検討
- 音素マッピングの最適化を実施

## 技術詳細

### OpenJTalkが生成する主な複数文字音素

| 音素 | 対応する音 | 分割後 |
|------|-----------|--------|
| ch   | ち        | c + h  |
| ts   | つ        | t + s  |
| sh   | し        | s + h  |
| ky   | きゃ      | k + y  |
| ny   | にゃ      | n + y  |
| hy   | ひゃ      | h + y  |
| my   | みゃ      | m + y  |
| ry   | りゃ      | r + y  |
| gy   | ぎゃ      | g + y  |
| j    | じ        | j      |
| by   | びゃ      | b + y  |
| py   | ぴゃ      | p + y  |

### 音素IDマッピングの仕組み

1. OpenJTalkがテキストから音素列を生成
2. 複数文字音素を単一文字に分割（現在の実装）
3. 各文字をUTF-8コードポイントに変換
4. モデルの`phoneme_id_map`でIDに変換
5. 存在しない音素はフォールバック処理

この仕組みにより、完全でない音素マップでも基本的な音声合成が可能になっています。