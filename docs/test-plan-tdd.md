# Piper TDD テスト計画

t-wadaのTDDサイクル（Red-Green-Refactor）に基づいた実装計画

## TDDの原則
1. **テストファースト**: 実装前にテストを書く
2. **小さなステップ**: 一度に一つのことだけをテストする
3. **仮実装→本実装**: まず最も簡単な実装でテストを通し、その後リファクタリング
4. **三角測量**: 複数の具体例から一般化を導く

## 1. 音素変換（Phonemization）のテストリスト

### 1.1 基本的な音素変換
- [ ] 空文字列を渡すと空の音素リストが返る
- [ ] "a"を渡すと["^", "a", "$"]が返る（開始・終了マーカー付き）
- [ ] "あ"を渡すと["^", "a", "$"]が返る（ひらがな→音素）
- [ ] "ア"を渡すと["^", "a", "$"]が返る（カタカナ→音素）

### 1.2 複数文字の処理
- [ ] "あい"を渡すと["^", "a", "i", "$"]が返る
- [ ] "hello"を渡すと英語音素が返る
- [ ] "こんにちは"を渡すと日本語音素が返る

### 1.3 特殊音素のマッピング
- [ ] "ち"を含む文字列で"ch"音素が正しくPUA文字にマッピングされる
- [ ] "つ"を含む文字列で"ts"音素が正しくPUA文字にマッピングされる
- [ ] "きゃ"を含む文字列で"ky"音素が正しくPUA文字にマッピングされる

### 1.4 エラーケース
- [ ] nullを渡すとエラーが発生する
- [ ] 不正なエンコーディングの文字列を渡すとエラーが発生する
- [ ] 対応していない言語コードを渡すとエラーが発生する

## 2. 音声合成エンジンのテストリスト

### 2.1 モデルのロード
- [ ] 存在しないモデルファイルを指定するとエラーが発生する
- [ ] 空のモデルファイルを指定するとエラーが発生する
- [ ] 正しいモデルファイルを指定するとモデルがロードされる
- [ ] モデルのconfig.jsonが存在しない場合エラーが発生する

### 2.2 音声生成
- [ ] 空の音素リストを渡すと無音の音声データが返る
- [ ] 単一音素を渡すと音声データが返る
- [ ] 複数音素を渡すと音声データが返る
- [ ] 音声データの長さが0より大きい

### 2.3 音声フォーマット
- [ ] 生成された音声のサンプルレートが設定値と一致する
- [ ] 生成された音声のビット深度が16bitである
- [ ] 生成された音声がモノラルである

## 3. OpenJTalk統合のテストリスト

### 3.1 初期化
- [ ] OpenJTalk辞書が存在しない場合、初期化に失敗する
- [ ] HTSボイスが存在しない場合、初期化に失敗する
- [ ] 正しい設定で初期化に成功する

### 3.2 音素抽出
- [ ] 日本語テキストから音素列が抽出される
- [ ] 句読点が正しく処理される
- [ ] 数字が正しく読みに変換される
- [ ] アルファベットが正しく処理される

### 3.3 フォールバック処理
- [ ] OpenJTalkが利用できない場合、エラーが発生する
- [ ] 環境変数が設定されていない場合、デフォルトパスを使用する

## 4. 前処理（Preprocessing）のテストリスト

### 4.1 音声ファイルの読み込み
- [ ] 存在しないファイルを指定するとエラーが発生する
- [ ] 対応していない形式のファイルを指定するとエラーが発生する
- [ ] WAVファイルが正しく読み込まれる
- [ ] サンプルレートが異なるファイルは自動的にリサンプリングされる

### 4.2 テキストの正規化
- [ ] 全角英数字が半角に変換される
- [ ] 改行コードが統一される
- [ ] 不要な空白が削除される
- [ ] 特殊文字が適切に処理される

### 4.3 データセットの分割
- [ ] データが訓練用・検証用・テスト用に分割される
- [ ] 分割の比率が指定通りになる
- [ ] 各分割にデータの重複がない

## 5. 学習（Training）のテストリスト

### 5.1 バッチ処理
- [ ] バッチサイズ1でデータが正しく処理される
- [ ] バッチサイズNでデータが正しく処理される
- [ ] 最後のバッチが正しくパディングされる

### 5.2 損失計算
- [ ] 損失値が0以上である
- [ ] 損失値が有限値である（inf/nanでない）
- [ ] 勾配が正しく計算される

### 5.3 チェックポイント
- [ ] チェックポイントが正しく保存される
- [ ] チェックポイントから学習が再開できる
- [ ] 指定した数のチェックポイントのみ保持される

## 6. エクスポート（Export）のテストリスト

### 6.1 ONNX変換
- [ ] PyTorchモデルがONNXに変換される
- [ ] 変換後のモデルで推論ができる
- [ ] 音素IDマップが正しく保存される

### 6.2 設定ファイル
- [ ] config.jsonが正しく生成される
- [ ] 必要なフィールドがすべて含まれる
- [ ] PUA文字マッピングが正しく記録される

## 7. 統合テストのリスト

### 7.1 End-to-End日本語
- [ ] 日本語テキストから音声ファイルが生成される
- [ ] 生成された音声が再生可能である
- [ ] 複数の文を含むテキストが正しく処理される

### 7.2 End-to-End英語  
- [ ] 英語テキストから音声ファイルが生成される
- [ ] 生成された音声が再生可能である

### 7.3 ストリーミング
- [ ] ストリーミングモードで音声が生成される
- [ ] チャンクごとに音声データが出力される

## 実装順序（TDDアプローチ）

1. **最小限の音素変換テスト**から開始
   - 空文字列のテスト（最も簡単）
   - 単一文字のテスト
   - 仮実装で通す

2. **モデルロードの基本テスト**
   - ファイル存在チェック
   - エラーハンドリング

3. **音声生成の基本テスト**
   - 無音生成
   - 単純な音声生成

4. **日本語特有の機能**
   - OpenJTalk統合
   - PUAマッピング

5. **統合テスト**
   - 全体の動作確認

各ステップで：
- Red: テストを書いて失敗を確認
- Green: 最小限の実装でテストを通す
- Refactor: コードを整理・最適化